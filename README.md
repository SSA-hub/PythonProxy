# PythonProxy

![alt text](https://github.com/SSA-hub/PythonProxy/blob/master/image.png)

HTTP прокси сервер, равномерно распределяющий нагрузку между таргер-сервисами.  
Адреса веб-сервисов задаются в файле proxy/src/appsettings.json  
Прокси сервер работает на хосте http://localhost:8000/ и принимает Get-запрос, который перенаправляет другому сервису.  

#### Обработка отключения таргет-сервиса
Если один из таргет-сервисов не отвечает на запрос, то этот запрос отправляется на другой таргет-сервис, при этом не ответивший сервис исключается из списка таргет-сервисов. Так происходит до тех пор, пока не будет найден работающий таргет сервис или до окончания перебора всех сервисов - если ни один не отвечает, выводится соответсвующее сообщение.
Раз в определенное в файле proxy/src/appsettings.json (поле sleeping) время в отдельном потоке происходит опрос всех удаленных таргет сервисов, если какой-то из них начал отвечать - он снова добавляется в список таргет-сервисов, и на него начинает поступать нагрузка.  

#### HashRing  
Для выбора, какому из таргет-сервисов необходимо делигировать выполнение запроса, используется простая реализация хеш-функции.  
Класс HashRing инициализируется списком значений, которые он должен будет возвращать по ключу (в нашем случае - список url таргет-сервисов). Получение значения осуществляется по целому ключу (в нашем случае - порядковый номер запроса). Берется остаток от деления ключа на количество элементов заданного массива - будет возвращен элемент с индексом, равным этому остатку.  
При удалении или добавлении нового элемента в массив изменяется и делитель, что позволяет и далее равномерно распределять элементы массива по ключам.  

#### Развертка
Proxy - proxy/Dockerfile
Target - target/Dockerfile
Файл docker-compose.yaml поднимает 1 прокси и 5 таргет сервисов, каждый в отдельном контейнере  

#### Ответы прокси-сервера
1) "Hello, world!" (status_code = 200) - нормальный ответ  
2) "All servers is off" (status_code = 500) - все сервисы-обработчики не отвечают  

#### Тестирование  
Можно запустить файл run.ps1, который выполнит следующие действия:  
1) Поднимает прокси и 5 таргет сервисов  
2) Запустит скрипт spamer.py, который отправляет Get-запрос на прокси-сервер каждые 0.2 секунды  
3) Через 100 секунд остановит 3-й таргер-сервис  
4) Еще через 100 секунд запустит 3-й таргет-сервис снова  
  
В файле test/testing_locust.py содержится скрипт для запуска locust, его можно запустить следующей командой:  
py -m locust -f testing_locust.py --host=http://localhost:8000  
Далее перейти по адресу http://localhost:8089/ и задать параметры тестирования.
